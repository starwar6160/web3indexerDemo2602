version: '3.8'

services:
  anvil:
    container_name: web3-indexer-anvil
    image: ghcr.io/foundry-rs/foundry:stable
    entrypoint: ["anvil", "--host", "0.0.0.0", "--port", "8545", "--block-time", "2"]
    ports:
      - "58545:8545"  # 使用 58545 端口避免 Hyper-V 冲突
    environment:
      - ANVIL_ACCOUNTS=10
      - ANVIL_BALANCE=1000000000000000000000
    restart: unless-stopped

  postgres:
    container_name: web3-indexer-db
    image: postgres:15
    ports:
      - "15432:5432"  # 使用 15432 端口避免 Hyper-V 冲突
    environment:
      - POSTGRES_DB=web3_indexer
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    restart: unless-stopped
    volumes:
      - postgres_data:/var/lib/postgresql/data

  indexer:
    build: .
    container_name: web3-indexer-app
    depends_on:
      - anvil
      - postgres
    environment:
      - RPC_URL=http://anvil:8545
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/postgres
    restart: unless-stopped

  # 管理容器 - 用于执行脚本和管理任务
  workspace:
    build:
      context: .
      dockerfile: Dockerfile.workspace
    container_name: web3-indexer-workspace
    depends_on:
      - postgres
      - anvil
    environment:
      - RPC_URL=http://anvil:8545
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/web3_indexer
    volumes:
      - .:/app
      - /app/node_modules
    working_dir: /app
    stdin_open: true
    tty: true
    command: /bin/bash

volumes:
  postgres_data: